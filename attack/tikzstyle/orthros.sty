\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{orthros}[2024/03/07 Utils for illustrating the ORTHROS cipher]

%%% PREREQUISITES %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\RequirePackage{spn}

\tikzset{diffone/.style={thick, orange}}
\tikzset{diffunknown/.style={thick, red, opacity=0.5}}
\tikzset{linone/.style={thin, tugblue, double distance=0.7pt}}
\tikzset{linunknown/.style={semithick, blue, double distance=0.7pt, fill opacity=1, opacity=0.4}}
\tikzset{common/.style={thick, tuggreen}}
\tikzset{keyone/.style={thick, blue}}
\tikzset{keyunknown/.style={thick, blue}}

\newcommand{\orthrospermnibbles}{
  \iforthrosbranchone
  % nibble permutation of Branch 1
  % 0 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31
  % 10 27 5 1 30 23 16 13 21 31 6 14 0 25 11 18 15 28 19 24 7 8 22 3 4 29 9 2 26 20 12 17
  \spnpermword{0/10, 1/27, 2/5, 3/1, 4/30, 5/23, 6/16, 7/13, 8/21, 9/31, 10/6, 11/14, 12/0, 13/25, 14/11, 15/18,
               16/15, 17/28, 18/19, 19/24, 20/7, 21/8, 22/22, 23/3, 24/4, 25/29, 26/9, 27/2, 28/26, 29/20, 30/12, 31/17}
  \else
  % nibble permutation of Branch 2
  % 0 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31
  % 26 13 7 11 29 0 17 21 23 5 18 25 12 10 28 2 14 19 24 22 1 8 4 31 15 6 27 9 16 30 20 3
  \spnpermword{0/26, 1/13, 2/7, 3/11, 4/29, 5/0, 6/17, 7/21, 8/23, 9/5, 10/18, 11/25, 12/12, 13/10, 14/28, 15/2,
               16/14, 17/19, 18/24, 19/22, 20/1, 21/8, 22/4, 23/31, 24/15, 25/6, 26/27, 27/9, 28/16, 29/30, 30/20, 31/3}
  \fi
}

\newcommand{\orthrospermbits}{
  \iforthrosbranchone
  % bit permutation of Branch 1
  % 0 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127
  % 6 46 62 126 70 52 28 14 36 125 72 83 106 95 4 35 25 41 10 76 87 74 120 42 88 21 11 67 64 38 112 50 85 109 24 65 99 0 49 37 8 66 114 47 127 100 56 40 13 117 78 86 92 58 124 101 55 89 97 9 18 116 59 15 20 45 75 2 77 27 1 60 115 107 26 69 119 3 84 51 123 110 31 82 113 53 81 102 63 118 93 12 30 94 108 32 5 111 29 43 91 19 79 33 73 44 98 48 22 61 68 105 34 71 54 104 17 57 80 103 96 121 23 39 122 90 7 16
  \spnpermbits{0/6, 1/46, 2/62, 3/126, 4/70, 5/52, 6/28, 7/14, 8/36, 9/125, 10/72, 11/83, 12/106, 13/95, 14/4, 15/35,
               16/25, 17/41, 18/10, 19/76, 20/87, 21/74, 22/120, 23/42, 24/88, 25/21, 26/11, 27/67, 28/64, 29/38, 30/112, 31/50,
               32/85, 33/109, 34/24, 35/65, 36/99, 37/0, 38/49, 39/37, 40/8, 41/66, 42/114, 43/47, 44/127, 45/100, 46/56, 47/40,
               48/13, 49/117, 50/78, 51/86, 52/92, 53/58, 54/124, 55/101, 56/55, 57/89, 58/97, 59/9, 60/18, 61/116, 62/59, 63/15,
               64/20, 65/45, 66/75, 67/2, 68/77, 69/27, 70/1, 71/60, 72/115, 73/107, 74/26, 75/69, 76/119, 77/3, 78/84, 79/51,
               80/123, 81/110, 82/31, 83/82, 84/113, 85/53, 86/81, 87/102, 88/63, 89/118, 90/93, 91/12, 92/30, 93/94, 94/108, 95/32,
               96/5, 97/111, 98/29, 99/43, 100/91, 101/19, 102/79, 103/33, 104/73, 105/44, 106/98, 107/48, 108/22, 109/61, 110/68, 111/105,
               112/34, 113/71, 114/54, 115/104, 116/17, 117/57, 118/80, 119/103, 120/96, 121/121, 122/23, 123/39, 124/122, 125/90, 126/7, 127/16}
  \else
  % bit permutation of Branch 2
  % 0 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127
  % 20 122 74 62 119 35 15 66 9 85 32 117 21 83 127 106 11 98 115 59 71 90 56 26 2 44 103 121 114 107 68 16 84 1 102 33 80 52 76 36 27 94 37 55 82 12 112 64 105 14 91 17 108 124 6 93 29 86 123 79 72 53 19 99 50 18 81 73 67 88 4 61 111 49 24 45 57 78 100 22 110 47 116 54 60 70 97 39 3 41 48 96 23 42 113 87 126 13 31 40 51 25 65 125 8 101 118 28 38 89 5 104 109 120 69 43 7 77 58 34 10 63 30 95 75 46 0 92
  \spnpermbits{0/20, 1/122, 2/74, 3/62, 4/119, 5/35, 6/15, 7/66, 8/9, 9/85, 10/32, 11/117, 12/21, 13/83, 14/127, 15/106,
               16/11, 17/98, 18/115, 19/59, 20/71, 21/90, 22/56, 23/26, 24/2, 25/44, 26/103, 27/121, 28/114, 29/107, 30/68, 31/16,
               32/84, 33/1, 34/102, 35/33, 36/80, 37/52, 38/76, 39/36, 40/27, 41/94, 42/37, 43/55, 44/82, 45/12, 46/112, 47/64,
               48/105, 49/14, 50/91, 51/17, 52/108, 53/124, 54/6, 55/93, 56/29, 57/86, 58/123, 59/79, 60/72, 61/53, 62/19, 63/99,
               64/50, 65/18, 66/81, 67/73, 68/67, 69/88, 70/4, 71/61, 72/111, 73/49, 74/24, 75/45, 76/57, 77/78, 78/100, 79/22,
               80/110, 81/47, 82/116, 83/54, 84/60, 85/70, 86/97, 87/39, 88/3, 89/41, 90/48, 91/96, 92/23, 93/42, 94/113, 95/87,
               96/126, 97/13, 98/31, 99/40, 100/51, 101/25, 102/65, 103/125, 104/8, 105/101, 106/118, 107/28, 108/38, 109/89, 110/5, 111/104,
               112/109, 113/120, 114/69, 115/43, 116/7, 117/77, 118/58, 119/34, 120/10, 121/63, 122/30, 123/95, 124/75, 125/46, 126/0, 127/92}
  \fi
}


\newcommand{\orthrospermbitskey}{
  \iforthrosbranchone
  % bit permutation of Branch 1
  % 0 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127
  % 0 53 87 73 22 95 99 48 61 36 108 1 24 67 119 93 54 103 69 112 16 111 94 122 31 66 33 83 47 3 65 62 123 9 101 19 5 58 89 37 38 51 28 106 82 76 121 4 70 7 42 92 104 80 45 75 114 17 2 97 46 107 63 18 109 15 127 43 13 59 29 125 77 11 50 30 12 90 118 64 20 35 57 10 124 56 68 91 116 21 84 98 52 81 126 34 105 27 120 74 6 85 40 72 113 41 23 49 79 55 102 8 117 39 88 26 25 110 14 32 115 100 86 71 78 44 96 60
  \spnpermbits{0/0, 1/53, 2/87, 3/73, 4/22, 5/95, 6/99, 7/48, 8/61, 9/36, 10/108, 11/1, 12/24, 13/67, 14/119, 15/93, 16/54, 17/103, 18/69, 19/112, 20/16, 21/111, 22/94, 23/122, 24/31, 25/66, 26/33, 27/83, 28/47, 29/3, 30/65, 31/62, 32/123, 33/9, 34/101, 35/19, 36/5, 37/58, 38/89, 39/37, 40/38, 41/51, 42/28, 43/106, 44/82, 45/76, 46/121, 47/4, 48/70, 49/7, 50/42, 51/92, 52/104, 53/80, 54/45, 55/75, 56/114, 57/17, 58/2, 59/97, 60/46, 61/107, 62/63, 63/18, 64/109, 65/15, 66/127, 67/43, 68/13, 69/59, 70/29, 71/125, 72/77, 73/11, 74/50, 75/30, 76/12, 77/90, 78/118, 79/64, 80/20, 81/35, 82/57, 83/10, 84/124, 85/56, 86/68, 87/91, 88/116, 89/21, 90/84, 91/98, 92/52, 93/81, 94/126, 95/34, 96/105, 97/27, 98/120, 99/74, 100/6, 101/85, 102/40, 103/72, 104/113, 105/41, 106/23, 107/49, 108/79, 109/55, 110/102, 111/8, 112/117, 113/39, 114/88, 115/26, 116/25, 117/110, 118/14, 119/32, 120/115, 121/100, 122/86, 123/71, 124/78, 125/44, 126/96, 127/60}
  \else
  % bit permutation of Branch 2
  % 0 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127
  % 76 30 53 35 31 46 2 79 11 125 110 87 39 91 14 101 97 118 36 48 29 80 57 115 49 18 74 85 61 82 105 126 70 12 47 111 51 17 66 1 60 96 116 71 81 114 104 15 42 124 100 4 113 44 75 89 23 0 84 107 32 26 88 8 69 121 38 94 37 86 54 21 62 123 41 10 16 95 117 65 45 50 72 20 109 58 7 67 108 28 3 55 92 103 24 5 77 9 27 102 122 6 106 22 99 34 90 56 43 83 120 64 78 59 119 93 40 98 52 68 112 33 63 25 19 73 127 13
  \spnpermbits{0/76, 1/30, 2/53, 3/35, 4/31, 5/46, 6/2, 7/79, 8/11, 9/125, 10/110, 11/87, 12/39, 13/91, 14/14, 15/101, 16/97, 17/118, 18/36, 19/48, 20/29, 21/80, 22/57, 23/115, 24/49, 25/18, 26/74, 27/85, 28/61, 29/82, 30/105, 31/126, 32/70, 33/12, 34/47, 35/111, 36/51, 37/17, 38/66, 39/1, 40/60, 41/96, 42/116, 43/71, 44/81, 45/114, 46/104, 47/15, 48/42, 49/124, 50/100, 51/4, 52/113, 53/44, 54/75, 55/89, 56/23, 57/0, 58/84, 59/107, 60/32, 61/26, 62/88, 63/8, 64/69, 65/121, 66/38, 67/94, 68/37, 69/86, 70/54, 71/21, 72/62, 73/123, 74/41, 75/10, 76/16, 77/95, 78/117, 79/65, 80/45, 81/50, 82/72, 83/20, 84/109, 85/58, 86/7, 87/67, 88/108, 89/28, 90/3, 91/55, 92/92, 93/103, 94/24, 95/5, 96/77, 97/9, 98/27, 99/102, 100/122, 101/6, 102/106, 103/22, 104/99, 105/34, 106/90, 107/56, 108/43, 109/83, 110/120, 111/64, 112/78, 113/59, 114/119, 115/93, 116/40, 117/98, 118/52, 119/68, 120/112, 121/33, 122/63, 123/25, 124/19, 125/73, 126/127, 127/13}
  \fi
}


\newcommand{\orthrosmixnibbles}[1][]{
  % TODO \ifsponconnectbits
  \foreach \s in {0,...,\Sboxes} {
    \draw (S\s|-here) coordinate[tee] (t\s);
  }
  \spnstep[0.5]
  \foreach \s in {0,...,\Sboxes} {
    \draw (S\s|-here) coordinate[xor] (x\s);
    \draw (x\s.south) coordinate      (Sh\s);
  }
  \foreach \block in {0,...,7} {
    \pgfmathsetmacro{\SA}{int(4*\block+0)}
    \pgfmathsetmacro{\SB}{int(4*\block+1)}
    \pgfmathsetmacro{\SC}{int(4*\block+2)}
    \pgfmathsetmacro{\SD}{int(4*\block+3)}

    \draw[->] (t\SA) -- (x\SB);
    \draw[->] (t\SA) -- (x\SC);
    \draw[->] (t\SA) -- (x\SD);

    \draw[->] (t\SB) -- (x\SA);
    \draw[->] (t\SB) -- (x\SC);
    \draw[->] (t\SB) -- (x\SD);

    \draw[->] (t\SC) -- (x\SA);
    \draw[->] (t\SC) -- (x\SB);
    \draw[->] (t\SC) -- (x\SD);

    \draw[->] (t\SD) -- (x\SA);
    \draw[->] (t\SD) -- (x\SB);
    \draw[->] (t\SD) -- (x\SC);
  }
  \spnstep[0.1]
}

\newcommand{\orthrosinit}[1][]{
  \spninit[#1]{32}{4}
}

\newif\iforthrosbranchone
\newif\ifspnconnectbits

\newcommand{\orthrosroundnibble}[1][]{
  \spnsbox
  \orthrospermnibbles
  \ifspnconnectbits
    \spnbittowordswitch
  \fi
  \orthrosmixnibbles
  \spnlinktrue
  % TODO add RK, RC
}


\newcommand{\orthrosroundbits}[1][]{
  \spnsbox
  \orthrospermbits
  \spnbittowordswitch
  \orthrosmixnibbles
  \spnwordtobitswitch
  % TODO add RK, RC
}

\newcommand{\orthrosmarkbits}[4][]{
  % #1 = style (optional)
  % #2 = active input bits to S-box (comma-separated index list)
  % #3 = active S-boxes (comma-separated index list)
  % #4 = active bit transitions (comma-separated list of from/to bit indices)

  \foreach \i in {#2} {
    \draw[->,#1] (bin\i) -- (bin\i|-S0.north);
  }

  \foreach \s in {#3} {
    \draw (S\s) node[sbox,#1,fill=white] (S\s) {$\mathcal{S}$};
  }

  % return to previous permutation
  \draw (here) coordinate (orighere)
        (S0.south) coordinate (here);
  \foreach \i in {0,...,\bits} {
    \draw (bh\i) coordinate (origbh\i)
          (bh\i|-here) coordinate (bh\i);
  }

  \ifx&#4&
  \else
    \spnpermbits[#1]{#4}
  \fi

  % restore previous state
  \draw (orighere) coordinate (here);
  \foreach \i in {0,...,\bits} {
    \draw (origbh\i) coordinate (bh\i);
  }
}

%\newcommand{\arxkey}[3][-.5]{
%  \draw (here-|B#2) coordinate[xor]     (s)
%      ++(#1,0)      node[inner sep=1pt] (k) {#3};
%  \draw[->] (k) -- (s);
%  \draw[->] (H#2) -- (s);
%  \draw (s.south) coordinate (H#2);
%}

\endinput
