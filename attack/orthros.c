#include "utils.c"

int ORTHROS(unsigned char *ptbr1, unsigned char *ciphertext,unsigned char *key, int offset, int roundNum, int mode, unsigned char *ptbr2);
int Process_Branch(unsigned char *state, unsigned char *rk, int BRANCH, int offset, int roundNum);
int BITPERM(unsigned char *state, int BRANCH);
int NIBBLEPERM(unsigned char *state, int BRANCH);
int KEYSCHEDULING(unsigned char *rk, int BRANCH);

int NIBBLEtoBIT(unsigned char *nibble, unsigned char *bit);
int BITtoNIBBLE(unsigned char *nibble, unsigned char *bit);

void DISPLAY(unsigned char *state, char *text);

const int modeLeftBr=0;
const int modeRightBr=1;
const int modePRF=2;

unsigned char RC_1[12][32] = {
    {0xa,0x0,0xa,0xc,0x9,0x3,0x2,0x9,0xa,0xc,0x4,0xb,0xc,0x9,0x9,0x1,0xc,0x2,0x3,0x1,0x3,0x2,0x1,0x9,0xc,0x1,0x9,0x3,0xc,0xa,0x8,0x1,},
    {0x4,0x4,0x2,0x0,0xc,0xb,0x8,0xb,0x4,0x9,0xc,0xc,0x9,0xb,0xa,0x8,0x8,0x2,0xc,0x1,0x0,0x4,0xb,0xa,0x4,0xa,0x2,0x2,0xc,0x9,0x1,0x8,},
    {0x3,0xc,0x0,0xb,0x2,0x0,0x3,0x1,0x4,0x3,0x1,0x0,0x4,0x4,0xc,0xc,0x3,0x1,0x4,0x0,0x1,0xa,0x4,0x1,0x2,0x9,0xa,0x1,0x0,0x8,0xb,0x8,},
    {0x3,0x3,0xc,0xc,0x1,0x0,0xa,0x4,0x0,0x4,0x3,0x2,0x8,0x9,0x9,0x4,0x1,0x1,0x8,0x3,0x3,0x2,0x3,0x8,0x4,0x9,0xc,0x2,0x2,0x3,0x0,0x4,},
    {0xa,0xa,0x8,0x2,0xc,0x1,0x1,0x1,0x8,0xb,0x9,0x2,0x9,0xa,0xc,0xa,0x0,0x4,0x0,0x9,0x4,0x2,0x4,0x0,0x8,0x8,0xb,0xa,0x2,0x8,0x1,0x4,},
    {0x2,0x0,0x8,0x1,0x3,0x8,0x0,0xc,0x9,0xc,0x2,0x9,0x0,0x8,0x8,0x2,0xa,0xa,0xc,0xb,0x2,0x2,0x3,0x1,0x1,0x4,0xa,0x4,0x4,0xa,0xa,0x4,},
    {0x9,0x8,0x1,0xc,0x0,0xc,0xb,0x2,0x2,0x1,0x4,0x4,0x0,0x8,0x4,0xb,0xa,0xb,0x3,0x2,0xc,0x9,0x9,0xa,0x2,0x3,0x0,0x9,0x4,0x2,0x3,0xa,},
    {0xb,0x2,0x4,0x1,0x1,0x9,0xb,0xc,0x3,0x3,0xc,0x1,0x8,0xb,0x2,0x9,0x3,0x8,0x9,0x0,0x0,0xc,0x8,0x4,0x8,0xa,0x2,0xb,0x2,0x4,0x2,0xb,},
    {0x3,0x4,0x9,0x1,0xa,0x3,0x0,0x1,0xa,0x4,0x3,0x0,0x8,0x2,0x2,0xa,0x1,0x9,0x3,0x3,0x2,0x4,0x1,0x0,0x9,0x9,0xc,0x9,0xb,0x0,0x3,0x9,},
    {0x3,0x0,0x1,0x2,0x4,0x8,0xa,0x0,0x9,0x3,0x9,0xb,0x9,0x2,0x2,0xc,0x3,0x8,0x0,0x3,0x3,0x0,0x3,0x1,0x8,0xa,0xa,0xc,0x4,0x0,0xb,0xa,},
    {0x4,0x4,0x0,0xa,0x9,0x0,0x4,0x9,0x0,0x4,0xb,0x1,0x4,0x1,0x4,0x9,0x2,0xa,0x0,0x4,0x8,0xb,0x8,0xa,0x9,0xb,0x2,0x1,0xb,0x3,0xc,0x4,},
    {0x9,0x2,0xc,0x8,0x1,0xb,0x0,0x0,0x0,0x8,0x9,0x9,0x8,0x2,0x9,0x8,0x2,0xa,0x4,0x4,0x1,0x0,0x2,0x3,0x3,0x2,0x9,0x0,0x9,0xc,0x2,0x0,},
};

unsigned char RC_2[12][32] = {
    {0xa,0x3,0x4,0xa,0x8,0xc,0xa,0x0,0xa,0x8,0x8,0xb,0x0,0x4,0xa,0x1,0x9,0x8,0x2,0xb,0x9,0x3,0x8,0x1,0xb,0x2,0xb,0xa,0xc,0xa,0xc,0x8,},
    {0xc,0xa,0x9,0x8,0x4,0x9,0x0,0xc,0x3,0x0,0x8,0xb,0x9,0xc,0x0,0xc,0x9,0x9,0x3,0x0,0x8,0xb,0xc,0x9,0x8,0x8,0x2,0x8,0x8,0xc,0x2,0xa,},
    {0x4,0x0,0x3,0xa,0x2,0x3,0x1,0x1,0xb,0xc,0xc,0xb,0x1,0x3,0xa,0x4,0xa,0xb,0x3,0x9,0xa,0x8,0xc,0x4,0x2,0xb,0xa,0x9,0x3,0x9,0x2,0x4,},
    {0x4,0x8,0x9,0x1,0x3,0xc,0x9,0xc,0x0,0xc,0x1,0x8,0x0,0x8,0xc,0xa,0x4,0x8,0x9,0x4,0xc,0x1,0x9,0xb,0x3,0x9,0x9,0xb,0x1,0x2,0x2,0x0,},
    {0x3,0x2,0xb,0x3,0x2,0x1,0x8,0x4,0x3,0x0,0x1,0x0,0x9,0xc,0xa,0x4,0xa,0x3,0x1,0xc,0xa,0x9,0x1,0x2,0x3,0x9,0xb,0x8,0xc,0x8,0x3,0x8,},
    {0x1,0x0,0xb,0xc,0xc,0x3,0x0,0x4,0xa,0x1,0xb,0x8,0x1,0x3,0xb,0x8,0x2,0x9,0xc,0x9,0x0,0xb,0x8,0xb,0xb,0x1,0x4,0x9,0x8,0xb,0xb,0x3,},
    {0xa,0x9,0x1,0xc,0x2,0x3,0x3,0xa,0x4,0x0,0xc,0x2,0x3,0x3,0xb,0x3,0x4,0xa,0x0,0x2,0x8,0x9,0x9,0x0,0x0,0x0,0x2,0xb,0x4,0x0,0x9,0x3,},
    {0x8,0xa,0x2,0x9,0x3,0x1,0xa,0xb,0x0,0x4,0x1,0x3,0xb,0xc,0x2,0xb,0xb,0x8,0x9,0xa,0x1,0x3,0xa,0xb,0xb,0xc,0x4,0xb,0x0,0x4,0x8,0xb,},
    {0x9,0xb,0x1,0xb,0x8,0xb,0xc,0x3,0x9,0x0,0xa,0x3,0x4,0x2,0x2,0x0,0x4,0x8,0x0,0x9,0x1,0x2,0x4,0xa,0x9,0xa,0x1,0x8,0x0,0xa,0x3,0x2,},
    {0xa,0x4,0xa,0xc,0x2,0x9,0xb,0x8,0x8,0x2,0x8,0x3,0xc,0x9,0x1,0x3,0xc,0xb,0x4,0x4,0x9,0x2,0xc,0x4,0x9,0x1,0xa,0xa,0x1,0x0,0x0,0xc,},
    {0xc,0xa,0xb,0x0,0x8,0x9,0x0,0x9,0x4,0x8,0x1,0x0,0xc,0xb,0x0,0x4,0x3,0x2,0x0,0x1,0xa,0x2,0x0,0xc,0x0,0xa,0xc,0xc,0x0,0x9,0xb,0x1,},
    {0x4,0xb,0xb,0xa,0x3,0xb,0x8,0x9,0x8,0x4,0xc,0xb,0x0,0x2,0x8,0xc,0x3,0x8,0x3,0x9,0x0,0x8,0x9,0xa,0x4,0xc,0xc,0xc,0xc,0xc,0xc,0x1,},
};

unsigned char permN1[32] = {10,27,5,1,30,23,16,13,21,31,6,14,0,25,11,18,15,28,19,24,7,8,22,3,4,29,9,2,26,20,12,17};
unsigned char permN2[32] = {26,13,7,11,29,0,17,21,23,5,18,25,12,10,28,2,14,19,24,22,1,8,4,31,15,6,27,9,16,30,20,3};

unsigned int permB1[128] = {6,46,62,126,70,52,28,14,36,125,72,83,106,95,4,35,25,41,10,76,87,74,120,42,88,21,11,67,64,38,112,50,85,109,24,65,99,0,49,37,8,66,114,47,127,100,56,40,13,117,78,86,92,58,124,101,55,89,97,9,18,116,59,15,20,45,75,2,77,27,1,60,115,107,26,69,119,3,84,51,123,110,31,82,113,53,81,102,63,118,93,12,30,94,108,32,5,111,29,43,91,19,79,33,73,44,98,48,22,61,68,105,34,71,54,104,17,57,80,103,96,121,23,39,122,90,7,16};
unsigned int permB2[128] = {20,122,74,62,119,35,15,66,9,85,32,117,21,83,127,106,11,98,115,59,71,90,56,26,2,44,103,121,114,107,68,16,84,1,102,33,80,52,76,36,27,94,37,55,82,12,112,64,105,14,91,17,108,124,6,93,29,86,123,79,72,53,19,99,50,18,81,73,67,88,4,61,111,49,24,45,57,78,100,22,110,47,116,54,60,70,97,39,3,41,48,96,23,42,113,87,126,13,31,40,51,25,65,125,8,101,118,28,38,89,5,104,109,120,69,43,7,77,58,34,10,63,30,95,75,46,0,92};

unsigned int permK1[128] = {0,53,87,73,22,95,99,48,61,36,108,1,24,67,119,93,54,103,69,112,16,111,94,122,31,66,33,83,47,3,65,62,123,9,101,19,5,58,89,37,38,51,28,106,82,76,121,4,70,7,42,92,104,80,45,75,114,17,2,97,46,107,63,18,109,15,127,43,13,59,29,125,77,11,50,30,12,90,118,64,20,35,57,10,124,56,68,91,116,21,84,98,52,81,126,34,105,27,120,74,6,85,40,72,113,41,23,49,79,55,102,8,117,39,88,26,25,110,14,32,115,100,86,71,78,44,96,60};
unsigned int permK2[128] = {76,30,53,35,31,46,2,79,11,125,110,87,39,91,14,101,97,118,36,48,29,80,57,115,49,18,74,85,61,82,105,126,70,12,47,111,51,17,66,1,60,96,116,71,81,114,104,15,42,124,100,4,113,44,75,89,23,0,84,107,32,26,88,8,69,121,38,94,37,86,54,21,62,123,41,10,16,95,117,65,45,50,72,20,109,58,7,67,108,28,3,55,92,103,24,5,77,9,27,102,122,6,106,22,99,34,90,56,43,83,120,64,78,59,119,93,40,98,52,68,112,33,63,25,19,73,127,13};

unsigned char SBOX[16] = {0x1,0x0,0x2,0x4,0x3,0x8,0x6,0xd,0x9,0xa,0xb,0xe,0xf,0xc,0x7,0x5};

// int main(void){

//     //unsigned char plaintext[32] = {0x0};
//     //unsigned char key[32] = {0x0};
//     unsigned char plaintext[32] = {0xa,0x9,0x4,0x7,0x4,0x3,0x6,0x7,0x1,0x0,0x9,0x2,0x4,0xc,0xc,0xd,0x4,0x7,0xf,0x2,0xd,0x5,0x7,0x1,0xd,0xe,0xe,0xa,0x8,0xf,0x0,0x5,};
//     unsigned char key[32] = {0x4,0xa,0x2,0xb,0xe,0x6,0x0,0xe,0x3,0xd,0xb,0x6,0xa,0xb,0xe,0x0,0xc,0x0,0x3,0xe,0xa,0xe,0xc,0x6,0x6,0xf,0xd,0x0,0x5,0xd,0x0,0xc,};
//    // char *plaintext="a947436710924ccd47f2d571deea8f05"; 
//     // char *key="4a2be60e3db6abe0c03eaec66fd05d0c";
//     //unsigned char key[32] = {0x4,0xa,0x2,0xb,0xe,0x6,0x0,0xe,0x3,0xd,0xb,0x6,0xa,0xb,0xe,0x0,0xc,0x0,0x3,0xe,0xa,0xe,0xc,0x6,0x6,0xf,0xd,0x0,0x5,0xd,0x0,0xc,};
//     unsigned char ciphertext[32] = {0x0};

//     ORTHROS(plaintext, ciphertext, key, offset, roundNum, modePRF);

//     DISPLAY(plaintext,"P");
//     DISPLAY(key, "K");
//     printf("C: ");
//     for(int i = 0; i < 32; i++){
//         printf("%x", ciphertext[i]);
//     }
//     printf("\n");

//     return 0;
// }

int ORTHROS( unsigned char *ptbr1, unsigned char *ciphertext, unsigned char *key, int offset, int roundNum, int mode, unsigned char *ptbr2){
    // unsigned char plaintext[32],key[32];
    // hex_string_to_bytes(pt,plaintext,sizeof(plaintext));
    // hex_string_to_bytes(K,key,sizeof(key));

    unsigned char rk1[32] = {0x0};
    unsigned char rk2[32] = {0x0};

    unsigned char X1[32] = {0x0};
    unsigned char X2[32] = {0x0};


    for(int i = 0; i < 32; i++){
        rk1[i] = key[i];
        rk2[i] = key[i];
        X1[i] = ptbr1[i];
        X2[i] = ptbr2[i];
    }
    if(mode==modeLeftBr){
        Process_Branch(X1, rk1, 1, offset, roundNum);
        for(int i = 0; i < 32; i++){
            ciphertext[i] = X1[i];
        }
    } else if(mode==modeRightBr){
        Process_Branch(X2, rk2, 2, offset, roundNum);
        for(int i = 0; i < 32; i++){
            ciphertext[i] = X2[i];
        }
    } else if(mode==modePRF){
        Process_Branch(X1, rk1, 1, offset, roundNum);
        Process_Branch(X2, rk2, 2, offset, roundNum);
        for(int i = 0; i < 32; i++){
            ciphertext[i] = X1[i] ^ X2[i];
        }
    }
    return 0;
  
}

int Process_Branch(unsigned char *state, unsigned char *rk, int BRANCH, int offset, int roundNum){

    //key whitening
    KEYSCHEDULING(rk, BRANCH);
    for(int i = 0; i < 32; i++){
        state[i] ^= rk[i];
    }

    //round function in 1st to 11th rounds   
    // roundNum-1 should be changed to roundNum if a complete last round is required; remove the last round codes in the end of this function  
    for(int r = offset; r < (offset+roundNum); r++){

        //sbox
        for(int i = 0; i < 32; i++){
            state[i] = SBOX[state[i]];
        }

        //test
        //printf("%d  ", BRANCH);
        //DISPLAY(state);
        //permutation
        if(r < 4){
            BITPERM(state, BRANCH);
        }
        else{
            NIBBLEPERM(state, BRANCH);
        }

        //mixcolumn
        unsigned char buf[32] = {0x0};
        for(int i = 0; i < 32; i++){
            buf[i] = state[i];
        }
        for(int i = 0; i < 8; i++){
            state[(i*4)+0] = buf[(i*4)+1] ^ buf[(i*4)+2] ^ buf[(i*4)+3];
            state[(i*4)+1] = buf[(i*4)+0] ^ buf[(i*4)+2] ^ buf[(i*4)+3];
            state[(i*4)+2] = buf[(i*4)+0] ^ buf[(i*4)+1] ^ buf[(i*4)+3];
            state[(i*4)+3] = buf[(i*4)+0] ^ buf[(i*4)+1] ^ buf[(i*4)+2];
        }

        //add roundkey and constant
        KEYSCHEDULING(rk, BRANCH);

        if(BRANCH == 1){
            for(int i = 0; i < 32; i++){
                state[i] ^= rk[i] ^ RC_1[r][i];
            }
        }
        else{
            for(int i = 0; i < 32; i++){
                state[i] ^= rk[i] ^ RC_2[r][i];
            }
        }
    }

    return 0;
}

int BITPERM(unsigned char *state, int BRANCH){

    //bit permutation
    unsigned char bit[128] = {0x0};
    unsigned char bit_buf[128] = {0x0};

    NIBBLEtoBIT(state, bit);

    if(BRANCH == 1){
        for(int i = 0; i < 128; i++){
            bit_buf[permB1[i]] = bit[i];
        }
    }
    else{
        for(int i = 0; i < 128; i++){
            bit_buf[permB2[i]] = bit[i];
        }
    }

    BITtoNIBBLE(state, bit_buf);

    return 0;
}

int NIBBLEPERM(unsigned char *state, int BRANCH){

    unsigned char nibble_buf[32] = {0x0};
    for(int i = 0; i < 32; i++){
        nibble_buf[i] = state[i];
    }

    if(BRANCH == 1){
        for(int i = 0; i < 32; i++){
            state[permN1[i]] = nibble_buf[i];
        }
    }
    else{
        for(int i = 0; i < 32; i++){
            state[permN2[i]] = nibble_buf[i];
        }
    }

    return 0;
}

int KEYSCHEDULING(unsigned char *rk, int BRANCH){

    unsigned char bit[128] = {0x0};
    unsigned char bit_buf[128] = {0x0};

    NIBBLEtoBIT(rk, bit);

    //permutation
    if(BRANCH == 1){
        for(int i = 0; i < 128; i++){
            bit_buf[permK1[i]] = bit[i];
        }
    }
    else{
        for(int i = 0; i < 128; i++){
            bit_buf[permK2[i]] = bit[i];
        }
    }

    BITtoNIBBLE(rk, bit_buf);

    return 0;
}


int NIBBLEtoBIT(unsigned char *nibble, unsigned char *bit){

    //initialization
    for(int i = 0; i < 128; i++){
        bit[i] = 0;
    }

    for(int i = 0; i < 32; i++){
        for(int j = 0; j < 4; j++){
            bit[(4*i)+j] = (nibble[i] >> (3-j)) & 0x1;
        }
    }

    return 0;
}

int BITtoNIBBLE(unsigned char *nibble, unsigned char *bit){

    //initialization
    for(int i = 0; i < 32; i++){
        nibble[i] = 0;
    }

    for(int i = 0; i < 32; i++){
        nibble[i] = (bit[(4*i)+0] << 3) ^ (bit[(4*i)+1] << 2) ^ (bit[(4*i)+2] << 1) ^ (bit[(4*i)+3] << 0);
    }

    return 0;
}

void DISPLAY(unsigned char *state, char *text){

    printf("%s: ", text);
    for(int i = 0; i < 32; i++){
        printf("%x", state[i]);
    }
    printf("\n");
}
